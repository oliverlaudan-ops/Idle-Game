<script>
// early error banner
(function(){function b(m){try{var el=document.getElementById('errorBanner');if(el){el.style.display='block';el.textContent=m;}}catch(_){};try{console.error('[BOOT]',m);}catch(_){}}
window.addEventListener('error',function(e){b('Fehler: '+(e.message||e.error||'Unbekannt')+' @ '+(e.filename||'')+':'+(e.lineno||''));});
window.addEventListener('unhandledrejection',function(e){b('Unhandled: '+(e.reason&&e.reason.message?e.reason.message:String(e.reason)));});
})();

try{
(function(){
// ---------- helpers ----------
function fmt(n){if(!isFinite(n))return'0';if(n>=1e12)return(n/1e12).toFixed(2)+'T';if(n>=1e9)return(n/1e9).toFixed(2)+'B';if(n>=1e6)return(n/1e6).toFixed(2)+'M';if(n>=1e3)return(n/1e3).toFixed(2)+'K';return(Math.floor(n*100)/100)+'';}

// ---------- state ----------
var DEFAULT={
  stein:0, holz:0, metall:0, kohle:0, stahl:0, energie:0, wissen:0,
  rpsStein:0, rpsHolz:0, rpsMetall:0, rpsKohle:0, rpsStahl:0, rpsEnergie:0, rpsWissen:0,
  rpcStein:1, rpcHolz:0, rpcMetall:0,
  totalEarned:0, ep:0, permBonus:0, autoBonus:0,
  unlocks:{holz:false, metall:false, kohle:false, stahl:false, energie:false, wissen:false},
  upgrades:{stone:{},wood:{},metal:{},coal:{},steel:{},energy:{},science:{}},
  research:{clickBoost:0,autoBoost:0,cheaper:0,offlineCap:0},
  achievements:{},
  lastTs:Date.now()
};
var state=JSON.parse(JSON.stringify(DEFAULT));
var PRESTIGE_REQ=50000;

// ---------- dom ----------
var resStats=document.getElementById('resourceStats');
var clickSteinBtn=document.getElementById('clickStein');
var clickHolzBtn=document.getElementById('clickHolz');
var holzClickCol=document.getElementById('holzClickCol');
var rpcSteinEl=document.getElementById('rpcStein');
var rpcHolzEl=document.getElementById('rpcHolz');
var upgradesEl=document.getElementById('upgrades');
var researchEl=document.getElementById('research');
var achieveEl=document.getElementById('achievements');
var saveBtn=document.getElementById('saveBtn');
var resetBtn=document.getElementById('resetBtn');
var exportBtn=document.getElementById('exportBtn');
var importBtn=document.getElementById('importBtn');
var epEl=document.getElementById('ep');
var multEl=document.getElementById('mult');
var prestigeBtn=document.getElementById('prestigeBtn');
var prestigeReqEl=document.getElementById('prestigeReq');
var tabUpg=document.getElementById('tabUpgrades');
var tabRes=document.getElementById('tabResearch');
var tabAch=document.getElementById('tabAchievements');
var panelUpg=document.getElementById('panelUpgrades');
var panelRes=document.getElementById('panelResearch');
var panelAch=document.getElementById('panelAchievements');
prestigeReqEl.textContent=PRESTIGE_REQ.toLocaleString('de-DE');

// ---------- math ----------
function gMult(){return(1+state.ep*0.01)*(1+state.permBonus);}
function cMult(){return gMult()*(1+state.research.clickBoost*0.25);}
function aMult(){return gMult()*(1+state.autoBonus)*(1+state.research.autoBoost*0.25);}
function kMult(){return Math.max(0.4,1-state.research.cheaper*0.05);}

// ---------- ui ----------
function statCard(label,value,perSec,perClick){
  var wrap=document.createElement('div');wrap.className='col';
  var card=document.createElement('div');card.className='stat';wrap.appendChild(card);
  var L=document.createElement('div');var R=document.createElement('div');R.style.textAlign='right';card.appendChild(L);card.appendChild(R);
  var b1=document.createElement('div');b1.className='badge';b1.textContent='Ressource';L.appendChild(b1);
  var b2=document.createElement('b');b2.className='mono';b2.textContent=label+': '+fmt(value);L.appendChild(b2);
  var r1=document.createElement('div');r1.className='badge';r1.textContent='Rate (pro Sek.)';R.appendChild(r1);
  var r2=document.createElement('b');r2.className='mono';r2.textContent='+'+(Math.round(perSec*100)/100).toFixed(2);R.appendChild(r2);
  if(perClick!=null){var r3=document.createElement('div');r3.className='badge';r3.textContent='Klick-Wert';R.appendChild(r3);
  var r4=document.createElement('b');r4.className='mono';r4.textContent='+'+fmt(perClick);R.appendChild(r4);}
  return wrap;
}
function renderStats(){
  resStats.innerHTML='';
  var mC=cMult(),mA=aMult();
  resStats.appendChild(statCard('Stein',state.stein,state.rpsStein*mA,state.rpcStein*mC));
  if(state.unlocks.holz) resStats.appendChild(statCard('Holz',state.holz,state.rpsHolz*mA,state.rpcHolz*mC));
  rpcSteinEl.textContent=fmt(state.rpcStein*mC);
  rpcHolzEl.textContent=fmt(state.rpcHolz*mC);
  holzClickCol.style.display=state.unlocks.holz?'':'none';
  epEl.textContent=state.ep; multEl.textContent=gMult().toFixed(2)+'x';
  var total=state.stein+state.holz+state.metall+state.kohle+state.stahl+state.energie+state.wissen+state.totalEarned;
  prestigeBtn.disabled=(total<PRESTIGE_REQ);
}
function renderUpgrades(){ // minimal starter set (keine Unicode in Strings)
  upgradesEl.innerHTML='';
  var grid=document.createDocumentFragment();
  function card(title,desc,costLbl,costVal,canBuy,onBuy){
    var c=document.createElement('div');c.className='card-sm';
    var h=document.createElement('h3');h.textContent=title;c.appendChild(h);
    var p=document.createElement('div');p.className='muted';p.textContent=desc;c.appendChild(p);
    var k=document.createElement('div');k.className='muted';k.textContent='Kosten: '+fmt(costVal)+' '+costLbl;c.appendChild(k);
    var b=document.createElement('button');b.className='buy '+(canBuy?'can':'cannot');b.textContent=canBuy?'Kaufen':'Nicht genug'; if(canBuy){b.onclick=onBuy;} c.appendChild(b);
    return c;
  }
  // Faustkeil
  var fkCost=10; var fkCan=state.stein>=fkCost;
  grid.appendChild(card('Faustkeil','+1 Stein/Klick','Stein',fkCost,fkCan,function(){state.stein-=fkCost; state.rpcStein+=1; renderAll();}));
  // Werkbank (Holz freischalten, 1 Holz/Klick)
  var wbCost=250; var wbCan=state.stein>=wbCost && !state.unlocks.holz;
  grid.appendChild(card('Werkbank','Schaltet HOLZ frei','Stein',wbCost,wbCan,function(){state.stein-=wbCost; state.unlocks.holz=true; if(!state.rpcHolz||state.rpcHolz<=0) state.rpcHolz=1; renderAll();}));
  upgradesEl.appendChild(grid);
}
function renderResearch(){ researchEl.innerHTML='(Demo)'; }
function renderAchievements(){ achieveEl.innerHTML='(Demo)'; }
function renderAll(){ renderStats(); renderUpgrades(); }

// ---------- tick ----------
function tick(){
  var now=Date.now(); var dt=(now-state.lastTs)/1000; state.lastTs=now;
  if(dt>10) dt=10;
  var mA=aMult();
  function add(a){ state.totalEarned+=a; return a; }
  state.stein+=add(state.rpsStein*mA*dt);
  if(state.unlocks.holz) state.holz+=add(state.rpsHolz*mA*dt);
  renderStats();
}

// ---------- save/load ----------
function save(){ try{localStorage.setItem('stone_idle_save_v2',JSON.stringify(state));}catch(e){} }
function load(){
  try{
    var raw=localStorage.getItem('stone_idle_save_v2'); if(!raw) return;
    var data=JSON.parse(raw); for(var k in data){ state[k]=data[k]; }
    if(!state.unlocks) state.unlocks={holz:false,metall:false,kohle:false,stahl:false,energie:false,wissen:false};
    if(state.unlocks.holz && (!state.rpcHolz||state.rpcHolz<=0)) state.rpcHolz=1;
  }catch(e){}
}

// ---------- tab ----------
function setTab(which){
  tabUpg.classList.remove('active');tabRes.classList.remove('active');tabAch.classList.remove('active');
  panelUpg.classList.remove('active');panelRes.classList.remove('active');panelAch.classList.remove('active');
  if(which==='upg'){tabUpg.classList.add('active');panelUpg.classList.add('active');}
  if(which==='res'){tabRes.classList.add('active');panelRes.classList.add('active');}
  if(which==='ach'){tabAch.classList.add('active');panelAch.classList.add('active');}
}

// ---------- events ----------
clickSteinBtn.addEventListener('click',function(){ var add=state.rpcStein*cMult(); state.stein+=add; state.totalEarned+=add; renderStats(); console.log('[CLICK STEIN]',add); });
clickHolzBtn.addEventListener('click',function(){ var add=state.rpcHolz*cMult(); state.holz+=add; state.totalEarned+=add; renderStats(); });
saveBtn.addEventListener('click',function(){ save(); renderAll(); });
resetBtn.addEventListener('click',function(){ if(confirm('Wirklich alles zuruecksetzen?')){ localStorage.removeItem('stone_idle_save_v2'); state=JSON.parse(JSON.stringify(DEFAULT)); renderAll(); }});
exportBtn.addEventListener('click',function(){ save(); var payload=btoa(unescape(encodeURIComponent(localStorage.getItem('stone_idle_save_v2')))); try{ if(navigator.clipboard&&navigator.clipboard.writeText){ navigator.clipboard.writeText(payload).catch(function(){});} }catch(_){ } alert('Export (Anfang):\\n'+payload.slice(0,96)+'...'); });
importBtn.addEventListener('click',function(){ var str=prompt('Export-String einfuegen:'); if(!str) return; try{ var json=decodeURIComponent(escape(atob(str))); localStorage.setItem('stone_idle_save_v2',json); var data=JSON.parse(json); for(var k in data){ state[k]=data[k]; } renderAll(); alert('Import OK'); }catch(e){ alert('Import fehlgeschlagen: '+e.message); }});
tabUpg.addEventListener('click',function(){ setTab('upg'); });
tabRes.addEventListener('click',function(){ setTab('res'); });
tabAch.addEventListener('click',function(){ setTab('ach'); });

// ---------- init ----------
load(); renderAll();
setInterval(function(){tick();},200);
setInterval(function(){save();},10000);
})();
}catch(e){
  var el=document.getElementById('errorBanner'); if(el){ el.style.display='block'; el.textContent='Init-Fehler: '+(e.message||e); }
  console.error('[INIT]', e);
}
</script>
